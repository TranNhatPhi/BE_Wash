const express = require("express");
const dotenv = require("dotenv");
const cors = require("cors");

dotenv.config();

const app = express();

// ‚öôÔ∏è Middleware
app.use(cors());
app.use(express.json());

// üü¢ Root endpoint
app.get("/", (req, res) => {
    res.json({
        message: "üöó CRM Wash API is running on Vercel!",
        version: "1.0.0",
        docs: "/api-docs",
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || "development"
    });
});

// üü¢ Health check endpoint
app.get("/health", (req, res) => {
    res.json({
        status: "OK",
        uptime: process.uptime(),
        environment: process.env.NODE_ENV || "development",
        nodeVersion: process.version,
        memoryUsage: process.memoryUsage()
    });
});

// üü¢ Database test endpoint
app.get("/api/db-test", async (req, res) => {
    try {
        res.json({
            message: "Database connection test",
            env: {
                DB_HOST: process.env.DB_HOST ? "‚úÖ Set" : "‚ùå Missing",
                DB_PORT: process.env.DB_PORT ? "‚úÖ Set" : "‚ùå Missing",
                DB_NAME: process.env.DB_NAME ? "‚úÖ Set" : "‚ùå Missing",
                DB_USER: process.env.DB_USER ? "‚úÖ Set" : "‚ùå Missing",
                DB_SSL: process.env.DB_SSL ? "‚úÖ Set" : "‚ùå Missing"
            }
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// üü¢ Test routes
app.get("/api/test", (req, res) => {
    res.json({
        message: "‚úÖ API routes working!",
        timestamp: new Date().toISOString(),
        method: req.method,
        url: req.url
    });
});

// üü¢ AUTH ROUTES
app.get("/api/auth/test", (req, res) => {
    res.json({
        message: "‚úÖ Auth routes working!",
        endpoint: "/api/auth/test"
    });
});

app.post("/api/auth/login", (req, res) => {
    const { email, password } = req.body;

    // Mock login logic
    if (!email || !password) {
        return res.status(400).json({
            error: "Email v√† password l√† b·∫Øt bu·ªôc",
            required: ["email", "password"]
        });
    }

    // Mock successful login
    res.json({
        message: "Login successful",
        user: {
            id: 1,
            email: email,
            name: "Test User"
        },
        token: "mock_jwt_token_here",
        expiresIn: "30d"
    });
});

app.post("/api/auth/register", (req, res) => {
    const { name, email, password } = req.body;

    if (!name || !email || !password) {
        return res.status(400).json({
            error: "Name, email v√† password l√† b·∫Øt bu·ªôc",
            required: ["name", "email", "password"]
        });
    }

    res.json({
        message: "Registration successful",
        user: {
            id: Date.now(),
            name,
            email,
            createdAt: new Date().toISOString()
        }
    });
});

// üü¢ VEHICLE ROUTES
app.get("/api/vehicles/test", (req, res) => {
    res.json({
        message: "‚úÖ Vehicle routes working!",
        endpoint: "/api/vehicles/test"
    });
});

app.get("/api/vehicles", (req, res) => {
    res.json({
        message: "Get all vehicles",
        data: [
            {
                id: 1,
                licensePlate: "30A-12345",
                brand: "Toyota",
                model: "Camry",
                year: 2020,
                color: "ƒêen"
            },
            {
                id: 2,
                licensePlate: "29B-67890",
                brand: "Honda",
                model: "Civic",
                year: 2019,
                color: "Tr·∫Øng"
            }
        ]
    });
});

app.post("/api/vehicles", (req, res) => {
    const { licensePlate, brand, model, year, color } = req.body;

    if (!licensePlate || !brand || !model) {
        return res.status(400).json({
            error: "LicensePlate, brand v√† model l√† b·∫Øt bu·ªôc",
            required: ["licensePlate", "brand", "model"]
        });
    }

    res.json({
        message: "Vehicle created successfully",
        data: {
            id: Date.now(),
            licensePlate,
            brand,
            model,
            year,
            color,
            createdAt: new Date().toISOString()
        }
    });
});

// üü¢ SERVICE ROUTES
app.get("/api/services", (req, res) => {
    res.json({
        message: "Get all services",
        data: [
            {
                id: 1,
                name: "R·ª≠a xe c∆° b·∫£n",
                price: 50000,
                duration: 30,
                description: "R·ª≠a ngo√†i, lau kh√¥"
            },
            {
                id: 2,
                name: "R·ª≠a xe VIP",
                price: 100000,
                duration: 60,
                description: "R·ª≠a ngo√†i, trong, h√∫t b·ª•i, ƒë√°nh b√≥ng"
            }
        ]
    });
});

app.post("/api/services", (req, res) => {
    const { name, price, duration, description } = req.body;

    if (!name || !price) {
        return res.status(400).json({
            error: "Name v√† price l√† b·∫Øt bu·ªôc",
            required: ["name", "price"]
        });
    }

    res.json({
        message: "Service created successfully",
        data: {
            id: Date.now(),
            name,
            price,
            duration,
            description,
            createdAt: new Date().toISOString()
        }
    });
});

// üü¢ CUSTOMER ROUTES
app.get("/api/customers", (req, res) => {
    res.json({
        message: "Get all customers",
        data: [
            {
                id: 1,
                name: "Nguy·ªÖn VƒÉn A",
                phone: "0901234567",
                email: "nguyenvana@email.com",
                address: "123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM"
            },
            {
                id: 2,
                name: "Tr·∫ßn Th·ªã B",
                phone: "0909876543",
                email: "tranthib@email.com",
                address: "456 ƒê∆∞·ªùng XYZ, Qu·∫≠n 2, TP.HCM"
            }
        ]
    });
});

app.post("/api/customers", (req, res) => {
    const { name, phone, email, address } = req.body;

    if (!name || !phone) {
        return res.status(400).json({
            error: "Name v√† phone l√† b·∫Øt bu·ªôc",
            required: ["name", "phone"]
        });
    }

    res.json({
        message: "Customer created successfully",
        data: {
            id: Date.now(),
            name,
            phone,
            email,
            address,
            createdAt: new Date().toISOString()
        }
    });
});

// üü¢ API Documentation
app.get("/api-docs", (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>CRM Wash API Documentation</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #333; }
                h2 { color: #666; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
                ul { list-style-type: none; padding: 0; }
                li { margin: 8px 0; }
                a { color: #007bff; text-decoration: none; }
                a:hover { text-decoration: underline; }
                .method { 
                    padding: 2px 8px; 
                    border-radius: 4px; 
                    color: white; 
                    font-size: 12px; 
                    margin-right: 10px;
                }
                .get { background-color: #28a745; }
                .post { background-color: #007bff; }
                .put { background-color: #ffc107; color: black; }
                .delete { background-color: #dc3545; }
                .endpoint { font-family: monospace; background: #f8f9fa; padding: 2px 4px; }
            </style>
        </head>
        <body>
            <h1>üöó CRM Wash API Documentation</h1>
            
            <h2>üîó Base URL</h2>
            <p><strong>${req.protocol}://${req.get('host')}</strong></p>
            
            <h2>üìã Available Endpoints:</h2>
            
            <h3>üè† General</h3>
            <ul>
                <li><span class="method get">GET</span><a href="/" target="_blank"><span class="endpoint">/</span> - Root endpoint</a></li>
                <li><span class="method get">GET</span><a href="/health" target="_blank"><span class="endpoint">/health</span> - Health check</a></li>
                <li><span class="method get">GET</span><a href="/api/test" target="_blank"><span class="endpoint">/api/test</span> - API test</a></li>
                <li><span class="method get">GET</span><a href="/api/db-test" target="_blank"><span class="endpoint">/api/db-test</span> - Database test</a></li>
            </ul>
            
            <h3>üîê Authentication</h3>
            <ul>
                <li><span class="method get">GET</span><a href="/api/auth/test" target="_blank"><span class="endpoint">/api/auth/test</span> - Auth test</a></li>
                <li><span class="method post">POST</span><span class="endpoint">/api/auth/login</span> - User login</li>
                <li><span class="method post">POST</span><span class="endpoint">/api/auth/register</span> - User registration</li>
            </ul>
            
            <h3>üöó Vehicles</h3>
            <ul>
                <li><span class="method get">GET</span><a href="/api/vehicles/test" target="_blank"><span class="endpoint">/api/vehicles/test</span> - Vehicle test</a></li>
                <li><span class="method get">GET</span><a href="/api/vehicles" target="_blank"><span class="endpoint">/api/vehicles</span> - Get all vehicles</a></li>
                <li><span class="method post">POST</span><span class="endpoint">/api/vehicles</span> - Create vehicle</li>
            </ul>
            
            <h3>üõ†Ô∏è Services</h3>
            <ul>
                <li><span class="method get">GET</span><a href="/api/services" target="_blank"><span class="endpoint">/api/services</span> - Get all services</a></li>
                <li><span class="method post">POST</span><span class="endpoint">/api/services</span> - Create service</li>
            </ul>
            
            <h3>üë• Customers</h3>
            <ul>
                <li><span class="method get">GET</span><a href="/api/customers" target="_blank"><span class="endpoint">/api/customers</span> - Get all customers</a></li>
                <li><span class="method post">POST</span><span class="endpoint">/api/customers</span> - Create customer</li>
            </ul>
            
            <h2>üìù Example Usage</h2>
            <h3>POST /api/auth/login</h3>
            <pre>{
  "email": "user@example.com",
  "password": "password123"
}</pre>
            
            <h3>POST /api/vehicles</h3>
            <pre>{
  "licensePlate": "30A-12345",
  "brand": "Toyota",
  "model": "Camry",
  "year": 2020,
  "color": "ƒêen"
}</pre>
            
            <p><em>Built with ‚ù§Ô∏è for CRM Wash System</em></p>
        </body>
        </html>
    `);
});

// üü¢ 404 handler
app.use("*", (req, res) => {
    res.status(404).json({
        message: "Endpoint not found",
        path: req.originalUrl,
        method: req.method,
        suggestion: "Check /api-docs for available endpoints",
        availableRoutes: [
            "GET /",
            "GET /health",
            "GET /api-docs",
            "GET /api/test",
            "GET /api/db-test",
            "GET /api/auth/test",
            "POST /api/auth/login",
            "POST /api/auth/register",
            "GET /api/vehicles",
            "POST /api/vehicles",
            "GET /api/services",
            "POST /api/services",
            "GET /api/customers",
            "POST /api/customers"
        ]
    });
});

// üü¢ Error handler
app.use((error, req, res, next) => {
    console.error("‚ùå Server error:", error.message);
    res.status(500).json({
        message: "Internal server error",
        error: process.env.NODE_ENV === 'development' ? error.message : 'Something went wrong',
        timestamp: new Date().toISOString()
    });
});

// üöÄ Ch·ªâ listen khi kh√¥ng ph·∫£i Vercel
if (!process.env.VERCEL && process.env.NODE_ENV !== 'production') {
    const PORT = process.env.PORT || 5000;
    app.listen(PORT, () => {
        console.log(`üöÄ Server ƒëang ch·∫°y tr√™n c·ªïng ${PORT}`);
        console.log(`üìÑ API Docs: http://localhost:${PORT}/api-docs`);
    });
}

// Export cho Vercel
module.exports = app;